### 0813 실행 계획 (오늘~3일)

## 0) 배경 요약
- 기준 문서: `0810_plan.md`, `0812_suggest.md`, `7_final_implementation_plan.md`
- 현재 상태(요지):
  - 인증/세션: JWT(httpOnly), Refresh, CSRF(Double Submit) 동작. 401 자동복구 로직 FE 적용.
  - RBAC/가드: 교사·관리자 API 보호 및 CSRF 요구 적용.
  - 출제/임포트/교사 그룹/토픽 API: 1차 구현/연동 완료.
  - 대시보드/학생지표: KPI/차트 확장, 병렬 로딩, 타임아웃 적용.
  - LLM: Provider 추상화(OpenRouter), 캐시/레이트리밋/타임아웃·재시도/텔레메트리 로깅 완료.
  - 미완(우선): 비용 가드, 서버 정렬 파라미터 정합성, Assign 스코핑, 인덱스 보강, 테스트 자동화.

---

## 1) 목표(0813~0815)
1) 보안/운영 검증 마무리: 레이트리밋·보안헤더·쿠키 설정 점검 및 대시보드형 메트릭 가시화(LLM 서킷 브레이커/쿼터).
2) 교사용 UX 안정화: 정렬/필터 서버 일관화, 네비 가드, 401→자동복구 후 명확 피드백.
3) 학습 스코핑 시작: 학생 Assign 스키마/엔드포인트 초안 및 FE 필터 반영.
4) 주관식/코드형 PoC: `answer_full_text` 수집 + 저비용 LLM 루브릭 템플릿 폴백.
5) 성능 토대: 핵심 인덱스/간단 캐시 키 명세, p95 확인 루틴.
6) 테스트/품질: 정답 정규화·유사도 유닛, 권한/CSRF/API 스모크, E2E 해피패스.
7) 개인화 인사이트: "어제의 나 vs 오늘의 나" LLM 요약/추천 카드(템플릿 폴백 포함) 초기 도입.

---

## 2) 우선순위(MoSCoW)
- MUST
  - LLM 서킷 브레이커/쿼터 메트릭 수집 및 상태 배너/엔드포인트 공개
  - 출제 리스트 `sort_by` 서버 파라미터(최신/난이도/토픽) 정합화 + FE 연동
  - 학생 Assign 스키마/읽기 API 초안 + 학생 화면 스코프 적용(가시적 효과)
  - 인덱스 2종: `questions(subject, topic)`, `submissions(user_id, submitted_at)`
- SHOULD
  - 코드형 정답 PoC(`answer_full_text`) + LLM 템플릿 폴백
  - 대시보드/학습지표 캐시 TTL·키 문서화(옵션 Redis)
  - LLM 인사이트 카드(MVP): 최근 성과 변화 요약 + 2개 행동 추천
- COULD
  - 교사용 네비 UX 개선(가드/배너/빈상태)
  - 비용 가드(일/사용자 한도) 1차 룰 기반

---

## 3) 상세 작업(모듈별)

### A. LLM 서킷 브레이커/쿼터 대시보드
**백엔드**
- 메트릭 수집: `calls_total`, `success_total`, `failure_total`, `cache_hit_total`, `latency_ms(p50/p95)`, `rpm_current`, `quota_remaining`(일/사용자 기준 옵션)
- 상태 엔드포인트: `GET /api/v1/feedback/providers/health` 확장(메트릭 요약 포함)
- 서킷 상태: open/half-open/closed + 전환 로그
**프론트**
- 관리자/교사용 전용 미니 대시보드 카드(성공률, p95, 캐시 Hit)
- 장애 시 배너: “저비용 모드/폴백 활성화”
**AC**
- 20명 동시 요청 시 p95<2s(캐시 hit 기준), 미캐시 시 5s 내 폴백 응답
- 서킷 open 시 LLM 호출 0, 템플릿 폴백 100%

### B. 출제 정렬/필터 서버 일관화
**백엔드**
- `GET /api/v1/admin/questions`에 `sort_by` 지원: `latest|difficulty_asc|difficulty_desc|topic_asc`
- 파라미터 검증/기본값 고정(`latest`)
**프론트**
- 드롭다운과 쿼리스트링 동기화, 새로고침 후 상태 보존
**AC**
- 페이지네이션+정렬 조합 일관, 동일 URL 재로딩 시 결과 동일

### C. 학생 Assign 스코프(초안)
**백엔드**
- 스키마: `student_assignments(id, user_id, subject, topic_key nullable, created_at)`
- API: `GET /api/v1/student/assignments`(본인), 교사용 관리 API(목록/추가)
- 읽기 경로에 스코프 필터 적용(대시보드/질문 조회)
**프론트**
- 학생 화면에서 subject/topic 선택 시 할당 범위 밖 항목 비표시
**AC**
- 학생은 미할당 데이터 미노출, 교사는 학생별 확인 가능

### D. 코드형 정답 PoC
**백엔드**
- `submission_items.answer_full_text` 수집(스키마 확장) 및 라이트웨이트 루브릭 채점 템플릿
- LLM 타임아웃/토큰 상한/재시도 2회, 실패 시 템플릿 폴백
**프론트**
- 문제 풀이 폼에 코드 입력 textarea(선택형 노출)
**AC**
- 간단 코드 문제에서 2~3문장 피드백, 실패 시 폴백 명시 표시

### E. 인덱스/캐시/관측성
- 인덱스 생성 2종(상기)
- 캐시 TTL·키 명세: 대시보드/학습지표 `user_id+subject` 30s
- 슬로우 쿼리 로그 점검, p95 지표 기록(대시보드 카드용)
**AC**
- p95 20~30% 개선, 슬로우 쿼리 경고 건수 감소

### F. 테스트/품질
- 유닛: 정규화/동의어/유사도(rapidfuzz) 테스트 케이스
- API: 출제/권한/CSRF/결과 접근 스모크
- E2E: 로그인→출제→풀이→결과→교사 대시보드 해피패스
**AC**
- 커버리지 ≥ 80%, 주요 플로우 녹색

### G. LLM 인사이트(개인화 성장 피드백)
**목표**
- 학생이 "어제의 나보다 성장한 오늘"을 느끼게 하는 2~3문장 요약 + 구체적 행동 추천 2개 제공

**백엔드**
- 입력 데이터: 최근 7~14일 `submissions` 집계(점수 추세, 시도 수, 약점 토픽 Top N)
- 엔드포인트: `GET /api/v1/student/insights?subject=`
  - 응답: `{ summary, suggestions: [string,string], deltas: { score_7d_pct, streak, recent7dAttempts } }`
- LLM 호출 정책: 캐시 TTL 60s, 타임아웃/재시도 동일, 실패 시 템플릿 폴백
- 프롬프트 톤: 코치형(구체적·짧고 실천적), 과장 금지, 숫자/지표 인용 시 반올림

**프론트**
- 학생 대시보드 상단 카드: "오늘의 인사이트"
- 구성: 요약(2~3문장) + 배지(전일 대비 ±Δ, streak) + 추천 버튼(눌렀을 때 추천 퀴즈/토픽으로 이동)

**AC**
- LLM 사용 시 1초 내 캐시 hit, 미캐시 시 5s 이내 폴백 포함 응답
- LLM 비활성/실패 시 템플릿으로 자연스럽게 대체(UX 깜빡임 없음)
- 요약 문구 과장/환각 최소(숫자는 서버 계산값만 사용)

---

## 4) 일정(제안)
- Day 1(0813): A(서킷 메트릭 수집/엔드포인트) + B(정렬 서버/FE) + E(인덱스)
- Day 2(0814): C(Assign 스키마+읽기 반영) + G(인사이트 API/카드 v1) + F(유닛/API 스모크)
- Day 3(0815): D(코드형 PoC) + A(프론트 미니 대시보드) + G(추천 액션 연동) + F(E2E)

---

## 5) 위험/완화
- LLM 비용/쿼터 초과: 서킷 open/저비용 모드, 캐시-only 모드 스위치
- 권한/스코프 회귀: API 테스트 강화, 가드 미들웨어 공통화
- 마이그레이션 리스크: Alembic 버전 태깅/롤백 스크립트 병행

---

## 6) 정의/수용 기준(요약)
- 보안·운영: 레이트리밋/보안헤더/쿠키 설정 점검 로그 및 대시보드에서 확인 가능
- 교사용 UX: 정렬/필터 URL 동기화, 401 자동복구 후 명확 에러 표기
- Assign: 학생 화면에서 미할당 항목 미노출, 교사 조회·관리 가능
- LLM: p95<2s(hit), 실패 시 폴백 100%, 서킷 상태/지표 노출
- 성능: 인덱스 적용 후 대시보드/학습지표 p95 20~30% 개선
- 테스트: 유닛/스모크/E2E 그린, 커버리지 ≥80%
- 인사이트: 요약+추천이 실제 데이터 변화(Δ)와 일치, 클릭 시 학습 동선으로 전환율 확인 가능

---

## 7) 오늘(0813) 착수 체크리스트
- [ ] LLM 메트릭 수집 구조 및 상태 엔드포인트 확장
- [ ] 출제 정렬 `sort_by` 파라미터 BE/FE 동기화
- [ ] 인덱스 생성 2종 및 p95 확인 쿼리 추가
- [ ] 간단 스모크: 교사 로그인→출제 리스트 정렬→임포트→대시보드 조회 200 확인
- [ ] 인사이트 스키마/계약 초안 확정(`summary/suggestions/deltas`)

---

## 8) 0812 추가요구사항 반영 계획(Pre-DreamPlan 포함 여부)
- 과목/토픽 Assign 스코프: Pre-DreamPlan 포함(진행 중)
  - 이유: 교수/원장 리뷰 시 실제 사용자 스코프 체감 효과 큼. 관리 API 최소 범위로 구현.
- 정답 입력란 2개(텍스트 영역 포함) + LLM 채점: Pre-DreamPlan PoC 포함(모듈 D)
  - 이유: 데모 가치 높음. 템플릿 폴백/타임아웃/비용 가드 하에 최소 기능.
- 복사 방지(JS 차단): 피드백 이후 반영(Pre-DreamPlan 이후)
  - 이유: 접근성/UX 영향 가능. 리뷰 피드백 확인 후 토글 가능 옵션으로 도입.
- 외부 에디터 연동(Colab, 2-pane 50/50): DreamPlan 이후
  - 이유: 도입·유지보수 부담/권한 문제. 샌드박스/에디터 전략 정립 후 추진.
- 나의 학습 지표 강화: Pre-DreamPlan 포함(인사이트/KPI v1 완료, v1.5는 여유 시)
  - 이유: “어제의 나 vs 오늘의 나” 가치 제공 핵심.
- 적응형 난이도: DreamPlan Phase B로 이관
  - 이유: 설계/검증 복잡도 높음. 데이터 축적 이후 단계에서 진행.



