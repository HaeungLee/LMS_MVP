### 0810 안정화 + 인증/RBAC 기반 설계 플랜

## 1) 목표(오늘~3일)

- 학생/교사 뷰 분리 전제: 최소 인증(JWT) + 역할(RBAC) 뼈대 구축
- 대시보드 안정화: 학생 중심 지표로 차트 교체, 축 라벨 가독성 해결
- 서버 안정성: 구조화 로깅, 결과 조회 DB 단일 소스화
- 결과 보기 복원: 최근활동 리스트 클릭 → `/results/:submission_id` 상세 페이지로 이동

## 2) 아키텍처 결정(수정 확정)

- 인증: FastAPI + JWT(Access/Refresh) + httpOnly 쿠키 전송
  - Access: 짧은 수명(기본 15분), httpOnly 쿠키
  - Refresh: 길게(기본 14일), httpOnly 쿠키, 로테이션 + 서버 저장 화이트리스트(백업 서버 자원 활용)
  - 비밀번호 해시: bcrypt (후속 argon2 전환 여지)
  - 자동 로그인: 앱 부팅 시 Silent Refresh로 갱신, "로그인 유지"(Remember me)로 TTL 연장
- RBAC: `users.role`(enum: student/teacher/admin) + 의존성 가드(`require_role`)
- 데이터 연계: `submissions.user_id` 필수(익명 제출 금지). 학생은 본인 데이터만, 교사는 반/과목 집계 접근
- 라우팅: 교사용 집계는 별도 엔드포인트(`/api/v1/teacher/...`)로 분리
- 차트: 학생용은 “파이썬 기초 콘텐츠 진행/이해도” 중심, 교사용은 “주제/문항 현황” 유지(별도 화면)
- 학생 대시보드 포커스 재정의: “주제별 문제 현황”은 교사/출제자 전용 화면으로 이관, 학생 메인에는 노출하지 않음(가독성/동기 부여 중심 재배치)
- 학생 지표 구조: 메인에 “전체 진행률(학습 커버리지)” 카드 + “나의 약점 Top 3” 카드(오늘의 학습 섹션과 열맞춤) + “토픽별 이해도” 차트 구성
- 토픽 택소노미/메타데이터 주도 설계(확장성): 과목/토픽/가중치/임계치/표시여부를 데이터로 관리하여 함수/클래스/데이터분석/크롤링/ML/DL 토픽 추가 시 코드 수정 없이 반영
  - 커버리지 정의: 완료 토픽의 가중치 합/코어 토픽 가중치 합(`completed_core_weight / total_core_weight`)
  - 완료 판정: `attempts ≥ min_attempts` 또는 `accuracy ≥ min_accuracy`(과목별 설정)
  - 약점 Top3: `attempts ≥ min_attempts` 충족 토픽 중 accuracy 오름차순 상위 3개(동률 시 최근 성능↓ → attempts↑)
- 로깅: 요청ID/레벨/컨텍스트 기반 구조화 로깅(PII 미기록)
- TTL 정책: 피드백 1년 보관 옵션은 스위치/배치 훅만 우선 추가(실 삭제는 후속)
- 보안: CSRF 토큰(더블 서브밋/헤더) + CORS/쿠키 설정(SameSite=Lax, 개발 환경 보정)

## 3) 백엔드 체크리스트

- [ ] DB: `users`(id uuid, email unique, password_hash, role enum, display_name, created_at, last_login_at)
- [ ] DB: `refresh_tokens`(user_id, token_id, issued_at, expires_at, revoked) — 리프레시 로테이션/화이트리스트
- [ ] 마이그레이션: Alembic 스크립트 생성/적용
- [ ] 마이그레이션(추가): 토픽 택소노미/설정 테이블 생성
  - [ ] `subjects(id, key unique, title, version, created_at)`
  - [ ] `topics(id, key unique, title, parent_topic_id nullable)`
  - [ ] `subject_topics(subject_key fk, topic_key fk, weight default 1, is_core bool, display_order int, show_in_coverage bool)`
  - [ ] `subject_settings(subject_key fk, min_attempts int default 3, min_accuracy float default 0.6)`
  - [ ] (옵션) `user_topic_stats(user_id, topic_key, attempts, correct, last_attempt_at)` 또는 머티리얼라이즈드 뷰
- [ ] 인증 API: `POST /api/v1/auth/register`, `POST /api/v1/auth/login`, `POST /api/v1/auth/refresh`, `POST /api/v1/auth/logout`, `GET /api/v1/auth/me`
- [ ] 보안: 비밀번호 해시(bcrypt), 입력 검증, 오류 메시지 일반화, CSRF 헤더 검증
- [ ] RBAC 가드: `require_role([teacher])`, `require_role([student])`
- [ ] 엔드포인트 분리: `GET /api/v1/teacher/dashboard/stats`(교사용 집계), 학생용은 `/api/v1/dashboard/stats`
- [ ] 제출 연계: `submissions.user_id` NOT NULL(익명 제출 금지)
- [ ] 결과 조회: 메모리 폴백 제거 → DB 단일 소스
- [ ] 시도 목록 API(학생/교사): `GET /api/v1/submissions?subject&from&to&limit&offset`
  - 학생: 본인 시도만 반환, 정렬 `submitted_at desc`
  - 교사: 과목/기간 필터로 반/전체 학생 집계 목록 반환(초기엔 전체 허용)
- [ ] 인덱스: `submissions.user_id`, `submissions.submitted_at` 복합 인덱스
- [ ] 학생 학습 지표 API: `GET /api/v1/student/learning-status?subject=python_basics`
  - 응답 확장: 
    - 전체 진행률(coverage): `covered_weight/total_core_weight` 및 `%`
    - 이해도(정답률): 토픽별/전체
    - 나의 약점 Top 3: 정답률 하위 3개 토픽(최소 시도수 임계치 포함)
    - 학습 페이스: 최근 7일 시도 수, 연속 학습 일수(streak)
    - 시간 지표(선택): `submissions.time_taken` 기반 p50/p95(충분 데이터 이후 활성)
    - 설정/버전: `min_attempts`, `min_accuracy`, `subject_version`
- [ ] 집계 로직: `submission_items` 기반 토픽별 정답/시도 집계, 목표치는 설정값 기반
- [ ] 시드 스크립트: 
  - [ ] `python_basics` 코어 8토픽(연산자, 변수·상수, 자료형, 튜플, 리스트, 딕셔너리, 조건문, 반복문)
  - [ ] 확장 토픽(functions, classes, exceptions, modules)은 초기 `is_core=false`로 시드
  - [ ] 향후 과목: `data_analysis(pandas/numpy/matplotlib/seaborn/data-cleaning/feature-engineering)`, `ml_dl(supervised/unsupervised/deep-learning/model-eval/deployment)` 시드 예시 추가
- [ ] 로깅: 요청ID/에러 로깅 미들웨어, PII 제외, 슬로우 쿼리 경고 로그
- [ ] TTL 훅: 1년 보관 스위치 플래그/배치 훅 골격만 추가(삭제/아카이브는 후속)
 - [ ] 인덱스 확장: `subject_topics(subject_key, display_order)`, `submission_items(topic)`, `submissions(user_id, submitted_at)`

## 4) 프론트엔드 체크리스트
- [ ] 로그인/회원가입 화면 + httpOnly 쿠키 기반 세션 처리(보호 라우팅)
- [ ] 자동 로그인: 앱 부팅 시 Silent Refresh, "로그인 유지" 옵션 제공(기본 ON)
- [ ] 역할 분기: 로그인 후 역할에 따라 학생/교사 대시보드로 이동
- [ ] 결과 보기 복원: 라우트 `/results/:submission_id` 보장(현재 경로 확인/미존재 시 추가)
- [ ] 최근활동 리스트: `GET /api/v1/submissions` 연동, 행 클릭 시 결과 화면으로 이동
- [ ] 학생 대시보드 개편(파이썬 기초 콘텐츠 중심): 
  - [ ] “주제별 문제 수(문항 현황)”는 교사용 화면으로 이관(학생 메인 비노출)
  - [ ] 메인 카드: “전체 진행률(coverage %)” 대형 카드(진행바/원형 게이지 중 택1)
  - [ ] 메인 카드: “나의 약점 Top 3” 카드(오늘의 학습 섹션과 동일 열정렬, 클릭 시 해당 토픽 퀴즈 추천)
  - [ ] 토픽 목록(권장 기본): 연산자, 변수·상수, 자료형, 튜플, 리스트, 딕셔너리, 조건문, 반복문
  - [ ] 차트 1: 토픽별 진행도(시도수/목표수 대비) — 수평 막대(라벨 겹침 방지)
  - [ ] 차트 2: 토픽별 이해도(정답률/강·약점 분류) — 도넛 또는 막대
  - [ ] 차트 라벨 정책: 긴 한글 토픽명 축약(`tickFormat`), 툴팁 기본, 필요 시 -45도 회전(수직축일 때만)
  - [ ] 컨테이너 레이아웃: 범례 외부 배치, `domainPadding`/`barRatio`로 겹침 0 보장, 320/768/1024/1440 반응형 확인
  - [ ] 하드코딩 제거: 토픽 목록/순서는 `GET /student/learning-status` 응답의 `topic_progress(title, display_order)`를 사용
  - [ ] 커버리지 게이지: 응답의 `coverage.value`, `covered_weight`, `total_core_weight` 바인딩
  - [ ] 약점 Top3: 응답의 `weaknesses` 사용(클릭 시 해당 토픽 추천 학습/퀴즈 이동)
- [ ] 과목 선택 UI(Select) → 백엔드 `subject` 파라미터 연동
- [ ] Victory 라벨 가독성: 수평 막대 + 축약/툴팁 + 필요 시 -45도 회전
- [ ] 에러/빈 상태 UI: 데이터 없음/로딩/실패 일관 처리
  - [ ] 교사용 화면 신설: “주제별 문제 현황” + “문항 난이도 분포” + “출제 관리 링크”

## 5) DevOps/설정
- [ ] `.env`에 `JWT_SECRET`, `JWT_EXPIRES_IN(15m)`, `REFRESH_EXPIRES_IN(14d)`
- [ ] 쿠키 설정: `httpOnly=true`, `sameSite=Lax`, 개발환경은 `secure=false`(로컬), 배포는 `secure=true`
- [ ] CSRF: 프론트에서 헤더 토큰 동봉, 서버 검증
- [ ] 샘플 계정 시드: `teacher@example.com` / `student@example.com`
- [ ] README 문서에 로그인/역할/엔드포인트/쿠키 정책 요약
 - [ ] Alembic: 택소노미/설정 테이블 마이그 버전 태깅, 롤백 스크립트 동봉
 - [ ] 시드: 과목/토픽/매핑/설정 데이터 삽입 스크립트 분리(`scripts/seed_taxonomy.py`)
 - [ ] 캐시: 대시보드/learning-status 응답 30s 캐시, 캐시 키에 `subject`/`user_id` 포함

## 6) QA/AC(수용 기준)
- [ ] 비로그인 접근 시 보호 라우트 차단(리다이렉트)
- [ ] 익명 제출 차단: 모든 제출은 `user_id`와 연계됨
- [ ] 학생 계정으로 교사용 API 접근 불가(403)
- [ ] 결과 조회는 재시작 후에도 100% DB에서 정상 동작(메모리 폴백 제거)
- [ ] 학생 대시보드 차트: 모바일/데스크톱에서 라벨 겹침 0, 로딩 < 800ms(캐시 포함)
- [ ] 자동 로그인(Silent Refresh) 정상 동작, 토큰 만료/로그아웃 시 정리됨
- [ ] 민감정보 로깅 없음, CSRF 검증 통과
- [ ] 최근활동에서 항목 클릭 시 결과 화면으로 이동, 새로고침/직접 진입 모두 정상 렌더
- [ ] 학생이 타인 `submission_id` 접근 시 403
 - [ ] “전체 진행률”/“나의 약점 Top 3” 카드가 메인 상단에서 좌측 “오늘의 학습”과 열맞춤 정렬
 - [ ] “나의 약점 Top 3”는 최소 시도수 임계치 적용(통계적 유의성), 클릭 시 해당 토픽 학습 동선 제공
 - [ ] 확장성: 새로운 과목/토픽/가중치/임계치/표시여부를 시드/설정 변경만으로 반영(FE 코드 수정 없음)
 - [ ] 정확도: 커버리지/약점 계산이 `subject_settings(min_attempts, min_accuracy)`에 동기화되어 일관성 유지
 - [ ] 성능: 캐시 hit 기준 초기 로딩 < 800ms, 1k~10k submissions에서 p95 < 300ms
 - [ ] 관측성: learning-status/대시보드 API에 요청ID 로깅, 슬로우쿼리 경고 확인 가능

## 7) 결정됨(요구 반영)
- 인증 전략: 자체 JWT + httpOnly 쿠키, Refresh 로테이션/화이트리스트, 자동 로그인 허용
- 역할 모델링: `users.role` enum으로 시작(추후 확장 가능)
- 학생 차트 지표: 파이썬 기초 콘텐츠별 진행도/이해도 중심
- 제출 정책: 익명 제출 금지(`submissions.user_id` 필수)
- 토큰 저장: httpOnly 쿠키(백업 서버 자원 적극 활용)
- 교사용 API: `/api/v1/teacher/*` 프리픽스 고정
- TTL 정책: 스위치/배치 훅만 우선, 실제 삭제/아카이브는 후속
 - 학생 메인: “전체 진행률” + “나의 약점 Top 3” + “토픽별 이해도” 중심으로 재배치(동기부여/가독성 우선)
 - “주제별 문제 현황”은 교사/출제자 전용 화면으로 이관(디자인 고도화 대상)
 - 커버리지/약점 계산은 메타데이터(과목-토픽 매핑, 가중치, 임계치, 표시여부, 버전) 기반으로 운영

## 10) 토픽 택소노미/커버리지 스펙(확정)

### 스키마
- `subjects(id, key unique, title, version, created_at)`
- `topics(id, key unique, title, parent_topic_id nullable)`
- `subject_topics(subject_key, topic_key, weight default 1, is_core bool, display_order int, show_in_coverage bool)`
- `subject_settings(subject_key, min_attempts int default 3, min_accuracy float default 0.6)`
- (옵션) `user_topic_stats(user_id, topic_key, attempts, correct, last_attempt_at)` 또는 뷰로 대체

### 커버리지/약점 산정 규칙
- 완료 토픽: `attempts ≥ min_attempts` 또는 `accuracy ≥ min_accuracy`
- 커버리지: `sum(weight of completed core topics) / sum(weight of core topics)`
- 약점 Top3: 후보군=`attempts ≥ min_attempts` 토픽, 정렬=accuracy 오름차순 → 최근 성능 낮은 순 → attempts 높은 순

### API 응답(`GET /api/v1/student/learning-status?subject=`)
```
{
  coverage: {
    value: number,            // 0~1
    covered_weight: number,
    total_core_weight: number,
    min_attempts: number,
    min_accuracy: number,
    subject_version: string
  },
  weaknesses: [{ topic_key, title, accuracy, attempts }],
  topic_progress: [{ topic_key, title, attempts, accuracy, display_order }],
  streak: number,
  recent7dAttempts: number
}
```

### 시드(예시)
- `python_basics`: 코어 8토픽(연산자, 변수·상수, 자료형, 튜플, 리스트, 딕셔너리, 조건문, 반복문)
- 확장 토픽: functions/classes/exceptions/modules(`is_core=false`) — 향후 승격 가능
- `data_analysis`: numpy/pandas/matplotlib/seaborn/data-cleaning/feature-engineering
- `ml_dl`: supervised/unsupervised/deep-learning/model-eval/deployment

### 인덱스/성능/캐시
- 인덱스: `submission_items(topic)`, `submissions(user_id, submitted_at)`, `subject_topics(subject_key, display_order)`
- 캐시: subject/user별 30s 캐시, LLM 포함 응답은 별도 TTL 정책


## 8) 일정(제안)
- Day 1~2: 인증/RBAC/학생 대시보드 개편 + 라벨 가독성 + DB 단일소스/로깅 + 결과 보기 복원/최근활동 연동
- Day 3~5: Phase 2 기능(출제 API/정답매칭 v1/LLM v1/TTL 훅 확장)

## 9) 위험/완화
- 인증 도입으로 프론트/백엔드 변경폭↑ → MVP 범위 최소화, 회귀 테스트 케이스 작성
- 차트 교체로 데이터 요구 변경 → 백엔드 응답 스키마에 여지 필드(`trend`, `targets`) 사전 확보
- RBAC 누락 리스크 → 엔드포인트별 역할 매트릭스 표 작성/검증


