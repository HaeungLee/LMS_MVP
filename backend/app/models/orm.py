from __future__ import annotations

from datetime import datetime
from typing import Optional

from sqlalchemy import (
    Boolean,
    Column,
    DateTime,
    Float,
    ForeignKey,
    Index,
    Integer,
    String,
    Text,
    ARRAY,
    JSON,
)
from sqlalchemy.orm import declarative_base, relationship


Base = declarative_base()


class Submission(Base):
    __tablename__ = "submissions"

    id = Column(String(36), primary_key=True, index=True)  # UUID ë¬¸ìì—´
    user_id = Column(Integer, nullable=True, index=True)
    subject = Column(String(100), nullable=False, index=True)
    total_score = Column(Float, nullable=False)
    max_score = Column(Integer, nullable=False)
    time_taken = Column(Integer, nullable=True)
    summary = Column(Text, nullable=True)
    recommendations_json = Column(Text, nullable=True)
    submitted_at = Column(DateTime, default=datetime.utcnow, nullable=False, index=True)

    items = relationship("SubmissionItem", back_populates="submission", cascade="all, delete-orphan")


class SubmissionItem(Base):
    __tablename__ = "submission_items"

    id = Column(Integer, primary_key=True, index=True)
    submission_id = Column(String(36), ForeignKey("submissions.id", ondelete="CASCADE"), nullable=False, index=True)
    question_id = Column(Integer, nullable=False)
    user_answer = Column(Text, nullable=False)
    skipped = Column(Boolean, default=False, nullable=False)
    score = Column(Float, nullable=False)
    correct_answer = Column(String(200), nullable=False)
    topic = Column(String(100), nullable=False, index=True)

    submission = relationship("Submission", back_populates="items")


class Feedback(Base):
    __tablename__ = "feedbacks"

    id = Column(Integer, primary_key=True, index=True)
    submission_item_id = Column(Integer, ForeignKey("submission_items.id", ondelete="CASCADE"), nullable=False, index=True)
    feedback_text = Column(Text, nullable=False)
    ai_generated = Column(Boolean, default=True, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)


class Question(Base):
    __tablename__ = "questions"

    id = Column(Integer, primary_key=True, index=True)
    subject = Column(String(100), nullable=False, index=True)
    topic = Column(String(100), nullable=False, index=True)
    
    # ê³„ì¸µì  êµ¬ì¡° ì§€ì›
    subject_path = Column(String(500), nullable=True, index=True)  # "/saas_dev/backend/python/variables"
    
    question_type = Column(String(50), nullable=False)
    code_snippet = Column(Text, nullable=False)
    correct_answer = Column(String(200), nullable=False)
    difficulty = Column(String(20), nullable=False)
    taxonomy_level = Column(String(50), nullable=True, default="application")  # ì¶”ê°€ëœ í•„ë“œ
    hint = Column(Text, nullable=True)  # ì¶”ê°€ëœ í•„ë“œ
    explanation = Column(Text, nullable=True)  # ì¶”ê°€ëœ í•„ë“œ
    rubric = Column(Text, nullable=True)
    created_by = Column(String(100), nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    is_active = Column(Boolean, default=True, nullable=False)

    # New columns for AI question support
    question_data = Column(JSON, nullable=True)  # Additional question data (JSONB in Postgres)
    question_metadata = Column(JSON, nullable=True)  # Metadata like hints, explanations (JSONB in Postgres)
    ai_generated = Column(Boolean, default=False, nullable=False)  # Whether generated by AI
    
    # Explicitly define the index with the existing name
    __table_args__ = (
        Index('idx_question_ai_generated', 'ai_generated'),
        Index('idx_question_subject_path', 'subject_path'),
    )


class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    email = Column(String(255), nullable=False, unique=True, index=True)
    password_hash = Column(String(255), nullable=False)
    password_salt = Column(String(64), nullable=False)
    role = Column(String(20), nullable=False, default="student", index=True)
    display_name = Column(String(100), nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    last_login_at = Column(DateTime, nullable=True)
    # Relationships (bring in session/activity models from older schema)
    quiz_sessions = relationship("QuizSession", back_populates="user")
    recent_activities = relationship("RecentActivity", back_populates="user")
    # MVP: êµ¬ë… ê´€ê³„
    subscriptions = relationship("Subscription", back_populates="user")


class RefreshToken(Base):
    __tablename__ = "refresh_tokens"

    id = Column(String(64), primary_key=True, index=True)  # token id
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    issued_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    expires_at = Column(DateTime, nullable=False)
    revoked = Column(Boolean, default=False, nullable=False)

class Subject(Base):
    __tablename__ = "subjects"

    id = Column(Integer, primary_key=True, index=True)
    key = Column(String(100), nullable=False, unique=True, index=True)
    title = Column(String(200), nullable=False)
    version = Column(String(50), nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    # Phase 8 ì¶”ê°€ ì»¬ëŸ¼ë“¤
    description = Column(Text, nullable=True)
    category = Column(String(50), nullable=True, default='programming_fundamentals')
    difficulty_level = Column(String(20), nullable=True, default='beginner')
    estimated_duration = Column(String(50), nullable=True)
    icon_name = Column(String(50), nullable=True)
    color_code = Column(String(10), nullable=True)
    is_active = Column(Boolean, nullable=True, default=True)
    order_index = Column(Integer, nullable=True, default=0)
    total_problems = Column(Integer, nullable=True, default=0)
    total_students = Column(Integer, nullable=True, default=0)
    average_completion_rate = Column(Float, nullable=True, default=0.0)
    updated_at = Column(DateTime, nullable=True, default=datetime.utcnow)


class Topic(Base):
    __tablename__ = "topics"

    id = Column(Integer, primary_key=True, index=True)
    key = Column(String(100), nullable=False, unique=True, index=True)
    title = Column(String(200), nullable=False)
    parent_topic_id = Column(Integer, ForeignKey("topics.id"), nullable=True)


class QuizSession(Base):
    """í€´ì¦ˆ ì„¸ì…˜ - database.pyì™€ ì¤‘ë³µë˜ë¯€ë¡œ orm.pyì˜ ì •ì˜ë¥¼ ìš°ì„  ì‚¬ìš©"""
    __tablename__ = "quiz_sessions"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
    session_type = Column(String(50), default="python_basics")
    total_questions = Column(Integer)
    answered_questions = Column(Integer)
    skipped_questions = Column(Integer)
    total_score = Column(Float)
    time_taken = Column(Integer)
    completed_at = Column(DateTime, default=datetime.utcnow)

    # quiz settings
    shuffle_enabled = Column(Boolean, default=True)
    easy_count = Column(Integer, default=4)
    medium_count = Column(Integer, default=4)
    hard_count = Column(Integer, default=2)

    # relationships
    user = relationship("User", back_populates="quiz_sessions")
    answers = relationship("QuizAnswer", back_populates="session", cascade="all, delete-orphan")


class QuizAnswer(Base):
    """í€´ì¦ˆ ë‹µë³€ - database.pyì™€ ì¤‘ë³µë˜ë¯€ë¡œ orm.pyì˜ ì •ì˜ë¥¼ ìš°ì„  ì‚¬ìš©"""
    __tablename__ = "quiz_answers"

    id = Column(Integer, primary_key=True, index=True)
    session_id = Column(Integer, ForeignKey("quiz_sessions.id", ondelete="CASCADE"), nullable=False, index=True)
    question_id = Column(Integer)
    user_answer = Column(Text)
    correct_answer = Column(String(200))
    is_correct = Column(Boolean)
    is_skipped = Column(Boolean, default=False)
    score = Column(Float, default=0.0)
    answered_at = Column(DateTime, default=datetime.utcnow)

    # relationship
    session = relationship("QuizSession", back_populates="answers")


class RecentActivity(Base):
    """ìµœê·¼ í™œë™ - database.pyì™€ ì¤‘ë³µë˜ë¯€ë¡œ orm.pyì˜ ì •ì˜ë¥¼ ìš°ì„  ì‚¬ìš©"""
    __tablename__ = "recent_activities"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    activity_type = Column(String(50))
    activity_description = Column(String(200))
    score = Column(Float, nullable=True)
    topic = Column(String(100), nullable=True)
    difficulty = Column(String(20), nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow)

    # relationship
    user = relationship("User", back_populates="recent_activities")


class SubjectTopic(Base):
    __tablename__ = "subject_topics"

    id = Column(Integer, primary_key=True, index=True)
    subject_key = Column(String(100), ForeignKey("subjects.key", ondelete="CASCADE"), nullable=False, index=True)
    topic_key = Column(String(100), ForeignKey("topics.key", ondelete="CASCADE"), nullable=False, index=True)
    weight = Column(Float, default=1.0, nullable=False)
    is_core = Column(Boolean, default=True, nullable=False)
    display_order = Column(Integer, default=0, nullable=False)
    show_in_coverage = Column(Boolean, default=True, nullable=False)
    # Phase 8 ì¶”ê°€ ì»¬ëŸ¼ë“¤
    topic_name = Column(String(200), nullable=True)
    description = Column(Text, nullable=True)
    order_index = Column(Integer, nullable=True)
    estimated_duration = Column(String(50), nullable=True)
    difficulty_level = Column(String(20), nullable=True)


class SubjectSettings(Base):
    __tablename__ = "subject_settings"

    id = Column(Integer, primary_key=True, index=True)
    subject_key = Column(String(100), ForeignKey("subjects.key", ondelete="CASCADE"), nullable=False, unique=True, index=True)
    min_attempts = Column(Integer, default=3, nullable=False)
    min_accuracy = Column(Float, default=0.6, nullable=False)


class Group(Base):
    __tablename__ = "groups"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(200), nullable=False, unique=True, index=True)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)


class GroupMember(Base):
    __tablename__ = "group_members"

    id = Column(Integer, primary_key=True, index=True)
    group_id = Column(Integer, ForeignKey("groups.id", ondelete="CASCADE"), nullable=False, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)


class TeacherGroup(Base):
    __tablename__ = "teacher_groups"

    id = Column(Integer, primary_key=True, index=True)
    group_id = Column(Integer, ForeignKey("groups.id", ondelete="CASCADE"), nullable=False, index=True)
    teacher_user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)


class StudentAssignment(Base):
    __tablename__ = "student_assignments"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    subject = Column(String(100), nullable=False, index=True)
    topic_key = Column(String(100), nullable=True, index=True)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False, index=True)


# Phase 1: í™•ì¥ ê°€ëŠ¥í•œ ì»¤ë¦¬í˜ëŸ¼ ì•„í‚¤í…ì²˜ ëª¨ë¸ë“¤

class CurriculumCategory(Base):
    """ì»¤ë¦¬í˜ëŸ¼ ì¹´í…Œê³ ë¦¬ (ìµœìƒìœ„ ë ˆë²¨)"""
    __tablename__ = "curriculum_categories"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), nullable=False, unique=True, index=True)  # 'saas_development'
    display_name = Column(String(100), nullable=False)  # 'SaaS ê°œë°œì ì¢…í•©ê³¼ì •'
    description = Column(Text, nullable=True)
    target_audience = Column(String(100), nullable=True)  # 'beginner_to_professional'
    estimated_total_months = Column(Integer, default=12)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    
    # ê´€ê³„ ì„¤ì •
    tracks = relationship("LearningTrack", back_populates="curriculum_category")


class LearningTrack(Base):
    """í•™ìŠµ íŠ¸ë™ (ì¤‘ê°„ ë ˆë²¨) - ìƒˆë¡œ ìƒì„±"""
    __tablename__ = "learning_tracks"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), nullable=False, unique=True, index=True)  # 'python_basics'
    display_name = Column(String(100), nullable=False)  # 'Python ê¸°ì´ˆ'
    category = Column(String(50), nullable=False)  # 'foundation', 'development', 'specialization'
    curriculum_category_id = Column(Integer, ForeignKey("curriculum_categories.id"), nullable=True)
    specialization_level = Column(String(50), default='general')  # 'general', 'specialist', 'expert', 'master'
    prerequisite_tracks = Column(ARRAY(Text), default=[])  # ì„ ìˆ˜ íŠ¸ë™ë“¤
    difficulty_level = Column(Integer, default=1)  # 1-5
    estimated_hours = Column(Integer, default=20)
    description = Column(Text, nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    
    # ê´€ê³„ ì„¤ì •
    curriculum_category = relationship("CurriculumCategory", back_populates="tracks")
    modules = relationship("LearningModule", back_populates="track")


class LearningModule(Base):
    """í•™ìŠµ ëª¨ë“ˆ (ìµœí•˜ìœ„ ë ˆë²¨)"""
    __tablename__ = "learning_modules"
    
    id = Column(Integer, primary_key=True, index=True)
    track_id = Column(Integer, ForeignKey("learning_tracks.id"), nullable=False)
    name = Column(String(100), nullable=False)  # 'react_hooks'
    display_name = Column(String(100), nullable=False)  # 'React Hooks ë§ˆìŠ¤í„°'
    module_type = Column(String(50), default='core')  # 'core', 'elective', 'project', 'certification'
    estimated_hours = Column(Integer, default=8)
    difficulty_level = Column(Integer, default=1)  # 1-5
    prerequisites = Column(ARRAY(Text), default=[])  # ë‹¤ë¥¸ ëª¨ë“ˆ ì´ë¦„ë“¤
    tags = Column(ARRAY(Text), default=[])  # ['frontend', 'state-management', 'hooks']
    industry_focus = Column(String(100), default='general')  # 'fintech', 'ecommerce', 'enterprise'
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    
    # ê´€ê³„ ì„¤ì •
    track = relationship("LearningTrack", back_populates="modules")
    resources = relationship("LearningResource", back_populates="module")


class LearningResource(Base):
    """AI ì°¸ê³ ìë£Œ ì‹œìŠ¤í…œ"""
    __tablename__ = "learning_resources"
    
    id = Column(Integer, primary_key=True, index=True)
    module_id = Column(Integer, ForeignKey("learning_modules.id"), nullable=True)
    track_id = Column(Integer, ForeignKey("learning_tracks.id"), nullable=False)
    sub_topic = Column(String(100), nullable=True)
    resource_type = Column(String(50), nullable=False)  # 'documentation', 'tutorial', 'video', 'project'
    title = Column(String(200), nullable=False)
    url = Column(Text, nullable=False)
    description = Column(Text, nullable=True)
    difficulty_level = Column(Integer, default=1)
    industry_focus = Column(String(100), default='general')
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    
    # ê´€ê³„ ì„¤ì •
    module = relationship("LearningModule", back_populates="resources")


# Phase 2: ê°œì¸í™” ì—”ì§„ì„ ìœ„í•œ ëª¨ë¸ë“¤

class UserProgress(Base):
    """ì‚¬ìš©ì í•™ìŠµ ì§„ë„ ì¶”ì """
    __tablename__ = "user_progress"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    track_id = Column(Integer, ForeignKey("learning_tracks.id"), nullable=False, index=True)
    module_id = Column(Integer, ForeignKey("learning_modules.id"), nullable=True, index=True)
    
    # ì§„ë„ ìƒíƒœ
    status = Column(String(50), default='not_started', nullable=False)  # 'not_started', 'in_progress', 'completed', 'paused'
    completion_percentage = Column(Float, default=0.0, nullable=False)  # 0.0 ~ 100.0
    started_at = Column(DateTime, nullable=True)
    completed_at = Column(DateTime, nullable=True)
    last_accessed_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    
    # í•™ìŠµ ë°ì´í„°
    total_attempts = Column(Integer, default=0, nullable=False)
    successful_attempts = Column(Integer, default=0, nullable=False)
    time_spent_minutes = Column(Integer, default=0, nullable=False)
    
    # ë©”íƒ€ë°ì´í„°
    current_difficulty = Column(Integer, default=1, nullable=False)  # ì ì‘í˜• ë‚œì´ë„
    learning_velocity = Column(Float, default=1.0, nullable=False)  # í•™ìŠµ ì†ë„ ê³„ìˆ˜
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    # ê´€ê³„ ì„¤ì •
    user = relationship("User")
    track = relationship("LearningTrack")
    module = relationship("LearningModule")


class UserWeakness(Base):
    """ì‚¬ìš©ì ì•½ì /ê°•ì  ë¶„ì„"""
    __tablename__ = "user_weaknesses"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    
    # ì•½ì  ë¶„ë¥˜
    category = Column(String(100), nullable=False, index=True)  # 'concept', 'syntax', 'logic', 'debugging'
    subcategory = Column(String(100), nullable=True)  # 'loops', 'functions', 'data_structures'
    topic = Column(String(100), nullable=False)  # êµ¬ì²´ì  ì£¼ì œ
    
    # ì•½ì  ë°ì´í„°
    error_count = Column(Integer, default=1, nullable=False)
    accuracy_rate = Column(Float, default=0.0, nullable=False)  # 0.0 ~ 1.0
    avg_time_taken = Column(Float, default=0.0, nullable=False)  # í‰ê·  ì†Œìš” ì‹œê°„(ì´ˆ)
    
    # AI ë¶„ì„ ê²°ê³¼
    weakness_type = Column(String(50), nullable=False)  # 'critical', 'moderate', 'minor'
    suggested_practice = Column(Text, nullable=True)  # AI ì¶”ì²œ ì—°ìŠµ ë°©ë²•
    improvement_trend = Column(String(20), default='stable', nullable=False)  # 'improving', 'stable', 'declining'
    
    # ë©”íƒ€ë°ì´í„°
    first_detected_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    last_updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    is_resolved = Column(Boolean, default=False, nullable=False)
    resolved_at = Column(DateTime, nullable=True)
    
    # ê´€ê³„ ì„¤ì •
    user = relationship("User")


class UserTrackProgress(Base):
    """ì‚¬ìš©ìë³„ íŠ¸ë™ ì§„í–‰ ìƒí™©"""
    __tablename__ = "user_track_progress"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    track_id = Column(Integer, ForeignKey("learning_tracks.id"), nullable=False, index=True)
    
    # íŠ¸ë™ ìƒíƒœ
    status = Column(String(50), default='not_started', nullable=False)
    enrollment_date = Column(DateTime, default=datetime.utcnow, nullable=False)
    estimated_completion_date = Column(DateTime, nullable=True)
    actual_completion_date = Column(DateTime, nullable=True)
    
    # ì§„ë„ ë©”íŠ¸ë¦­
    modules_completed = Column(Integer, default=0, nullable=False)
    total_modules = Column(Integer, default=0, nullable=False)
    overall_accuracy = Column(Float, default=0.0, nullable=False)
    total_time_spent = Column(Integer, default=0, nullable=False)  # ë¶„ ë‹¨ìœ„
    
    # ê°œì¸í™” ë°ì´í„°
    preferred_difficulty = Column(Integer, default=2, nullable=False)  # 1-5
    learning_pace = Column(String(20), default='normal', nullable=False)  # 'slow', 'normal', 'fast'
    industry_preference = Column(String(100), default='general', nullable=False)
    
    # ì¶”ì²œ ì‹œìŠ¤í…œ ë°ì´í„°
    next_recommended_module_id = Column(Integer, ForeignKey("learning_modules.id"), nullable=True)
    recommendation_reason = Column(Text, nullable=True)
    last_recommendation_at = Column(DateTime, nullable=True)
    
    # ë©”íƒ€ë°ì´í„°
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    # ê´€ê³„ ì„¤ì •
    user = relationship("User")
    track = relationship("LearningTrack")
    next_recommended_module = relationship("LearningModule", foreign_keys=[next_recommended_module_id])


class LearningGoal(Base):
    """ì‚¬ìš©ì í•™ìŠµ ëª©í‘œ"""
    __tablename__ = "learning_goals"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    
    # ëª©í‘œ ì„¤ì •
    title = Column(String(200), nullable=False)
    description = Column(Text, nullable=True)
    target_completion_date = Column(DateTime, nullable=True)
    priority_level = Column(Integer, default=3, nullable=False)  # 1(ë‚®ìŒ) ~ 5(ë†’ìŒ)
    
    # ëª©í‘œ ë¶„ë¥˜
    goal_type = Column(String(50), nullable=False)  # 'skill_mastery', 'project_completion', 'career_milestone'
    target_tracks = Column(ARRAY(Integer), default=[], nullable=False)  # ê´€ë ¨ íŠ¸ë™ IDë“¤
    success_criteria = Column(Text, nullable=True)  # ì„±ê³µ ê¸°ì¤€
    
    # ì§„í–‰ ìƒí™©
    status = Column(String(50), default='active', nullable=False)  # 'active', 'completed', 'paused', 'cancelled'
    progress_percentage = Column(Float, default=0.0, nullable=False)
    milestones_achieved = Column(ARRAY(Text), default=[], nullable=False)
    
    # ë©”íƒ€ë°ì´í„°
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    completed_at = Column(DateTime, nullable=True)
    
    # ê´€ê³„ ì„¤ì •
    user = relationship("User")


class PersonalizedRecommendation(Base):
    """ê°œì¸í™”ëœ ì¶”ì²œ ê¸°ë¡"""
    __tablename__ = "personalized_recommendations"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    
    # ì¶”ì²œ ë‚´ìš©
    recommendation_type = Column(String(50), nullable=False)  # 'next_module', 'skill_reinforcement', 'career_path'
    recommended_item_type = Column(String(50), nullable=False)  # 'module', 'track', 'resource', 'project'
    recommended_item_id = Column(Integer, nullable=False)
    
    # ì¶”ì²œ ì´ìœ 
    reasoning = Column(Text, nullable=False)
    confidence_score = Column(Float, default=0.5, nullable=False)  # 0.0 ~ 1.0
    algorithm_version = Column(String(50), default='v1.0', nullable=False)
    
    # ì‚¬ìš©ì ë°˜ì‘
    user_action = Column(String(50), nullable=True)  # 'accepted', 'declined', 'ignored', 'postponed'
    feedback_rating = Column(Integer, nullable=True)  # 1-5 ë³„ì 
    user_feedback = Column(Text, nullable=True)
    
    # ê²°ê³¼ ì¶”ì 
    was_helpful = Column(Boolean, nullable=True)
    completion_rate = Column(Float, nullable=True)  # ì¶”ì²œ í•­ëª© ì™„ë£Œìœ¨
    time_to_complete = Column(Integer, nullable=True)  # ì™„ë£Œê¹Œì§€ ì†Œìš” ì‹œê°„(ë¶„)
    
    # ë©”íƒ€ë°ì´í„°
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    actioned_at = Column(DateTime, nullable=True)
    completed_at = Column(DateTime, nullable=True)
    
    # ê´€ê³„ ì„¤ì •
    user = relationship("User")


# Phase 2: ì‹¤ë¬´ í”„ë¡œì íŠ¸ ì—°ê³„ ëª¨ë¸ë“¤

class ProjectTemplate(Base):
    """ì‹¤ë¬´ í”„ë¡œì íŠ¸ í…œí”Œë¦¿"""
    __tablename__ = "project_templates"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(200), nullable=False, unique=True, index=True)
    display_name = Column(String(200), nullable=False)
    description = Column(Text, nullable=False)
    
    # í”„ë¡œì íŠ¸ ë¶„ë¥˜
    project_type = Column(String(50), nullable=False)  # 'web_app', 'api', 'data_analysis', 'mobile_app'
    difficulty_level = Column(Integer, default=2, nullable=False)  # 1-5
    estimated_hours = Column(Integer, default=20, nullable=False)
    
    # ê¸°ìˆ  ìŠ¤íƒ
    required_skills = Column(ARRAY(Text), default=[], nullable=False)  # í•„ìˆ˜ ê¸°ìˆ 
    technologies = Column(ARRAY(Text), default=[], nullable=False)    # ì‚¬ìš© ê¸°ìˆ 
    industry_focus = Column(String(100), default='general', nullable=False)
    
    # í”„ë¡œì íŠ¸ êµ¬ì¡°
    project_structure = Column(Text, nullable=True)  # JSON í˜•íƒœì˜ í”„ë¡œì íŠ¸ êµ¬ì¡°
    starter_code = Column(Text, nullable=True)       # ì‹œì‘ ì½”ë“œ
    requirements_file = Column(Text, nullable=True)  # requirements.txt ë‚´ìš©
    
    # í‰ê°€ ê¸°ì¤€
    evaluation_criteria = Column(Text, nullable=False)  # í‰ê°€ ê¸°ì¤€
    success_metrics = Column(ARRAY(Text), default=[], nullable=False)
    
    # ë©”íƒ€ë°ì´í„°
    is_active = Column(Boolean, default=True, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    # ê´€ê³„ ì„¤ì •
    user_projects = relationship("UserProject", back_populates="template")


class UserProject(Base):
    """ì‚¬ìš©ì í”„ë¡œì íŠ¸ ì§„í–‰ ìƒí™©"""
    __tablename__ = "user_projects"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    template_id = Column(Integer, ForeignKey("project_templates.id"), nullable=False, index=True)
    
    # í”„ë¡œì íŠ¸ ìƒíƒœ
    status = Column(String(50), default='not_started', nullable=False)  # 'not_started', 'in_progress', 'completed', 'paused'
    started_at = Column(DateTime, nullable=True)
    completed_at = Column(DateTime, nullable=True)
    deadline = Column(DateTime, nullable=True)
    
    # ì§„í–‰ ì •ë³´
    progress_percentage = Column(Float, default=0.0, nullable=False)
    current_milestone = Column(String(100), nullable=True)
    completed_milestones = Column(ARRAY(Text), default=[], nullable=False)
    
    # í”„ë¡œì íŠ¸ íŒŒì¼
    project_repository = Column(String(500), nullable=True)  # GitHub ë“± ì €ì¥ì†Œ URL
    deployed_url = Column(String(500), nullable=True)        # ë°°í¬ëœ í”„ë¡œì íŠ¸ URL
    submission_files = Column(Text, nullable=True)           # ì œì¶œ íŒŒì¼ ì •ë³´ (JSON)
    
    # í‰ê°€ ê²°ê³¼
    self_evaluation_score = Column(Float, nullable=True)     # ìê¸° í‰ê°€ ì ìˆ˜
    peer_evaluation_score = Column(Float, nullable=True)     # ë™ë£Œ í‰ê°€ ì ìˆ˜
    instructor_evaluation_score = Column(Float, nullable=True)  # ê°•ì‚¬ í‰ê°€ ì ìˆ˜
    final_score = Column(Float, nullable=True)
    
    # í”¼ë“œë°±
    instructor_feedback = Column(Text, nullable=True)
    improvement_suggestions = Column(Text, nullable=True)
    
    # ë©”íƒ€ë°ì´í„°
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    # ê´€ê³„ ì„¤ì •
    user = relationship("User")
    template = relationship("ProjectTemplate", back_populates="user_projects")


class Portfolio(Base):
    """ì‚¬ìš©ì í¬íŠ¸í´ë¦¬ì˜¤"""
    __tablename__ = "portfolios"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, unique=True, index=True)
    
    # ê¸°ë³¸ ì •ë³´
    title = Column(String(200), nullable=False)
    bio = Column(Text, nullable=True)
    profile_image_url = Column(String(500), nullable=True)
    
    # ê¸°ìˆ  ìŠ¤íƒ
    skills = Column(ARRAY(Text), default=[], nullable=False)
    specializations = Column(ARRAY(Text), default=[], nullable=False)
    
    # ì—°ë½ì²˜
    email = Column(String(100), nullable=True)
    github_url = Column(String(500), nullable=True)
    linkedin_url = Column(String(500), nullable=True)
    website_url = Column(String(500), nullable=True)
    
    # í¬íŠ¸í´ë¦¬ì˜¤ ì„¤ì •
    is_public = Column(Boolean, default=False, nullable=False)
    custom_domain = Column(String(100), nullable=True, unique=True)
    theme = Column(String(50), default='modern', nullable=False)
    
    # í†µê³„
    view_count = Column(Integer, default=0, nullable=False)
    last_viewed_at = Column(DateTime, nullable=True)
    
    # ë©”íƒ€ë°ì´í„°
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    # ê´€ê³„ ì„¤ì •
    user = relationship("User")
    project_showcases = relationship("PortfolioProject", back_populates="portfolio")


class PortfolioProject(Base):
    """í¬íŠ¸í´ë¦¬ì˜¤ì— í‘œì‹œí•  í”„ë¡œì íŠ¸"""
    __tablename__ = "portfolio_projects"
    
    id = Column(Integer, primary_key=True, index=True)
    portfolio_id = Column(Integer, ForeignKey("portfolios.id", ondelete="CASCADE"), nullable=False, index=True)
    user_project_id = Column(Integer, ForeignKey("user_projects.id"), nullable=True)  # ì—°ê³„ëœ í•™ìŠµ í”„ë¡œì íŠ¸
    
    # í”„ë¡œì íŠ¸ ì •ë³´
    title = Column(String(200), nullable=False)
    description = Column(Text, nullable=False)
    technologies = Column(ARRAY(Text), default=[], nullable=False)
    
    # ë§í¬
    demo_url = Column(String(500), nullable=True)
    repository_url = Column(String(500), nullable=True)
    
    # ì´ë¯¸ì§€/ë¯¸ë””ì–´
    thumbnail_url = Column(String(500), nullable=True)
    screenshots = Column(ARRAY(Text), default=[], nullable=False)
    
    # ë©”íƒ€ë°ì´í„°
    display_order = Column(Integer, default=0, nullable=False)
    is_featured = Column(Boolean, default=False, nullable=False)
    completion_date = Column(DateTime, nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    
    # ê´€ê³„ ì„¤ì •
    portfolio = relationship("Portfolio", back_populates="project_showcases")
    user_project = relationship("UserProject")


# Phase 8 ì¶”ê°€ ëª¨ë¸ë“¤

class SubjectCategory(Base):
    """ê³¼ëª© ì¹´í…Œê³ ë¦¬ í…Œì´ë¸” (scriptsì—ì„œ ìƒì„±ë¨)"""
    __tablename__ = "subject_categories"
    
    id = Column(Integer, primary_key=True, index=True)
    key = Column(String(50), unique=True, nullable=False, index=True)
    name = Column(String(100), nullable=False)
    description = Column(Text, nullable=True)
    color_code = Column(String(10), nullable=True)
    order_index = Column(Integer, default=0)
    created_at = Column(DateTime, default=datetime.utcnow)


class SubjectHierarchy(Base):
    """ê³„ì¸µì  ê³¼ëª© êµ¬ì¡° - ë¬´í•œ í™•ì¥ ê°€ëŠ¥"""
    __tablename__ = "subject_hierarchy"
    
    id = Column(Integer, primary_key=True, index=True)
    key = Column(String(100), nullable=False, unique=True, index=True)
    title = Column(String(200), nullable=False)
    
    # ê³„ì¸µ êµ¬ì¡°
    parent_id = Column(Integer, ForeignKey("subject_hierarchy.id"), nullable=True, index=True)
    level = Column(Integer, nullable=False, default=0, index=True)  # 0:ì¹´í…Œê³ ë¦¬, 1:ì˜ì—­, 2:ê³¼ëª©, 3:í† í”½
    path = Column(String(500), nullable=False, unique=True, index=True)  # "/saas_dev/backend/python/variables"
    
    # ë©”íƒ€ë°ì´í„°
    description = Column(Text, nullable=True)
    difficulty_level = Column(String(20), default='beginner')
    estimated_duration = Column(String(50), nullable=True)
    
    # UI ì •ë³´
    icon_name = Column(String(50), nullable=True)
    color_code = Column(String(10), nullable=True)
    order_index = Column(Integer, default=0)
    
    # ìƒíƒœ
    is_active = Column(Boolean, default=True, nullable=False)
    is_core = Column(Boolean, default=True, nullable=False)  # í•µì‹¬/ì„ íƒ ì—¬ë¶€
    
    # í†µê³„ (ìë™ ê³„ì‚°)
    total_problems = Column(Integer, default=0)
    total_students = Column(Integer, default=0)
    average_completion_rate = Column(Float, default=0.0)
    
    # í•™ìŠµ ê²½ë¡œ ì •ë³´
    prerequisites = Column(ARRAY(String), default=list)  # ì„ ìˆ˜ ê³¼ëª©/í† í”½ í‚¤ë“¤
    learning_objectives = Column(JSON, default=list)
    
    # ìƒì„±/ìˆ˜ì • ì‹œê°„
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    # ê´€ê³„
    parent = relationship("SubjectHierarchy", remote_side=[id], back_populates="children")
    children = relationship("SubjectHierarchy", back_populates="parent", cascade="all, delete-orphan")
    
    # ì¸ë±ìŠ¤
    __table_args__ = (
        Index('idx_subject_hierarchy_path', 'path'),
        Index('idx_subject_hierarchy_level', 'level'),
        Index('idx_subject_hierarchy_parent_id', 'parent_id'),
        Index('idx_subject_hierarchy_active', 'is_active'),
    )


# ============================================================
# MVP: ê²°ì œ ë° êµ¬ë… ì‹œìŠ¤í…œ
# ============================================================

class Subscription(Base):
    """
    ì‚¬ìš©ì êµ¬ë… ì •ë³´
    
    ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™:
    - í•œ ì‚¬ìš©ìëŠ” í•˜ë‚˜ì˜ í™œì„± êµ¬ë…ë§Œ ê°€ëŠ¥
    - ì²´í—˜(trial) â†’ ìœ ë£Œ(active) ìë™ ì „í™˜
    - ì·¨ì†Œ ì‹œ current_period_endê¹Œì§€ ìœ ì§€
    """
    __tablename__ = "subscriptions"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, unique=True, index=True)
    
    # êµ¬ë… ìƒíƒœ
    status = Column(String(20), nullable=False, default="trial", index=True)  # trial, active, cancelled, expired
    plan = Column(String(20), nullable=False, default="monthly")  # monthly, annual
    
    # ì²´í—˜ ê¸°ê°„
    trial_start_date = Column(DateTime, nullable=True)
    trial_end_date = Column(DateTime, nullable=True)
    
    # ê²°ì œ ê¸°ê°„
    current_period_start = Column(DateTime, nullable=True)
    current_period_end = Column(DateTime, nullable=True)
    
    # ì·¨ì†Œ ê´€ë ¨
    cancel_at_period_end = Column(Boolean, default=False, nullable=False)
    cancelled_at = Column(DateTime, nullable=True)
    
    # íƒ€ì„ìŠ¤íƒ¬í”„
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False, index=True)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    # Relationships
    user = relationship("User", back_populates="subscriptions")
    payments = relationship("Payment", back_populates="subscription", cascade="all, delete-orphan")
    
    # ì¸ë±ìŠ¤
    __table_args__ = (
        Index('idx_subscription_user_status', 'user_id', 'status'),
        Index('idx_subscription_period_end', 'current_period_end'),
    )


class Payment(Base):
    """
    ê²°ì œ íŠ¸ëœì­ì…˜ ê¸°ë¡
    
    ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™:
    - êµ¬ë…ê³¼ 1:N ê´€ê³„ (ê°±ì‹ ë§ˆë‹¤ ìƒˆ ê²°ì œ)
    - ì‹¤íŒ¨í•œ ê²°ì œë„ ê¸°ë¡ (ì¬ì‹œë„ ì¶”ì )
    - order_idëŠ” unique (ë©±ë“±ì„± ë³´ì¥)
    """
    __tablename__ = "payments"

    id = Column(Integer, primary_key=True, index=True)
    subscription_id = Column(Integer, ForeignKey("subscriptions.id", ondelete="CASCADE"), nullable=False, index=True)
    
    # í† ìŠ¤í˜ì´ë¨¼ì¸  ì •ë³´
    payment_key = Column(String(255), nullable=True, unique=True, index=True)  # í† ìŠ¤ ê²°ì œ í‚¤
    order_id = Column(String(255), nullable=False, unique=True, index=True)  # ì£¼ë¬¸ ID (ë©±ë“±ì„±)
    
    # ê²°ì œ ì •ë³´
    amount = Column(Integer, nullable=False)  # ê²°ì œ ê¸ˆì•¡ (ì›)
    status = Column(String(20), nullable=False, default="pending", index=True)  # pending, success, failed, refunded
    payment_method = Column(String(50), nullable=True)  # card, bank, etc
    
    # ê²°ì œ ê²°ê³¼
    paid_at = Column(DateTime, nullable=True)
    failed_reason = Column(Text, nullable=True)
    
    # í™˜ë¶ˆ ì •ë³´
    refunded_at = Column(DateTime, nullable=True)
    refund_reason = Column(Text, nullable=True)
    refund_amount = Column(Integer, nullable=True)
    
    # íƒ€ì„ìŠ¤íƒ¬í”„
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False, index=True)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    # Relationships
    subscription = relationship("Subscription", back_populates="payments")
    
    # ì¸ë±ìŠ¤
    __table_args__ = (
        Index('idx_payment_subscription_status', 'subscription_id', 'status'),
        Index('idx_payment_created_at', 'created_at'),
    )


class Quote(Base):
    """
    ëª…ì–¸ ì‹œìŠ¤í…œ
    
    166ê°œ ëª…ì–¸ì„ DBë¡œ ê´€ë¦¬í•˜ì—¬:
    - ë™ì  ìˆ˜ì • ê°€ëŠ¥
    - ì¹´í…Œê³ ë¦¬ë³„ í•„í„°ë§
    - ëœë¤ ì„ íƒ ìµœì í™”
    """
    __tablename__ = "quotes"

    id = Column(Integer, primary_key=True, index=True)
    
    # ë‚´ìš©
    content = Column(Text, nullable=False)
    author = Column(String(100), nullable=True)
    source = Column(String(200), nullable=True)
    
    # ë¶„ë¥˜
    category = Column(String(50), nullable=True, index=True)  # "courage", "failure", "success", "persistence", etc.
    
    # ë©”íƒ€ë°ì´í„°
    order_number = Column(Integer, nullable=False, unique=True, index=True)  # 1-166 (ì›ë³¸ ìˆœì„œ)
    is_active = Column(Boolean, default=True, nullable=False, index=True)
    
    # íƒ€ì„ìŠ¤íƒ¬í”„
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    # ì¸ë±ìŠ¤
    __table_args__ = (
        Index('idx_quote_category_active', 'category', 'is_active'),
        Index('idx_quote_active_order', 'is_active', 'order_number'),
    )


class UserNote(Base):
    """
    ì‚¬ìš©ì ë©”ëª¨ ì‹œìŠ¤í…œ
    
    í•™ìŠµ ì¤‘ ì‘ì„±í•˜ëŠ” ë©”ëª¨ë¥¼ ê´€ë¦¬:
    - ì»¤ë¦¬í˜ëŸ¼ë³„ ë©”ëª¨
    - ì„¹ì…˜ë³„ ë©”ëª¨ (êµì¬/ì‹¤ìŠµ/í€´ì¦ˆ)
    - ê²€ìƒ‰ ë° í•„í„°ë§
    """
    __tablename__ = "user_notes"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    
    # ì—°ê²°ëœ í•™ìŠµ ì½˜í…ì¸ 
    track_id = Column(Integer, ForeignKey("learning_tracks.id"), nullable=True, index=True)
    module_id = Column(Integer, ForeignKey("learning_modules.id"), nullable=True, index=True)
    section = Column(String(50), nullable=True)  # "textbook", "practice", "quiz", "general"
    
    # ë©”ëª¨ ë‚´ìš©
    title = Column(String(200), nullable=True)  # ë©”ëª¨ ì œëª© (ì„ íƒì )
    content = Column(Text, nullable=False)
    
    # íƒœê·¸ ë° ë¶„ë¥˜
    tags = Column(ARRAY(String), default=list, nullable=False)  # ["python", "loops", "debugging"]
    is_important = Column(Boolean, default=False, nullable=False)  # ì¤‘ìš” ë©”ëª¨ í‘œì‹œ
    
    # íƒ€ì„ìŠ¤íƒ¬í”„
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False, index=True)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    # ê´€ê³„ ì„¤ì •
    user = relationship("User")
    track = relationship("LearningTrack")
    module = relationship("LearningModule")
    
    # ì¸ë±ìŠ¤
    __table_args__ = (
        Index('idx_user_note_user_created', 'user_id', 'created_at'),
        Index('idx_user_note_track', 'track_id'),
        Index('idx_user_note_module', 'module_id'),
        Index('idx_user_note_important', 'is_important'),
    )


# ============================================================
# Phase C: ê°ì„±ì  ê¸°ëŠ¥ (Emotional Support)
# ============================================================

class LearningContext(Base):
    """
    í•™ìŠµ ì»¨í…ìŠ¤íŠ¸ ì¶”ì 
    
    í•™ìŠµìì˜ í˜„ì¬ ìƒíƒœ, ê°ì •, í™˜ê²½ì„ ê¸°ë¡í•˜ì—¬
    ê°œì¸í™”ëœ ì§€ì› ì œê³µ
    """
    __tablename__ = "learning_contexts"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    
    # í•™ìŠµ ì„¸ì…˜ ì •ë³´
    session_id = Column(String(100), nullable=True, index=True)  # ì„¸ì…˜ êµ¬ë¶„ìš©
    track_id = Column(Integer, ForeignKey("learning_tracks.id"), nullable=True)
    module_id = Column(Integer, ForeignKey("learning_modules.id"), nullable=True)
    
    # ê°ì • ìƒíƒœ (ê¸°ë¶„ ì²´í¬ì¸)
    mood = Column(String(20), nullable=True)  # "great", "good", "okay", "struggling", "frustrated"
    energy_level = Column(Integer, nullable=True)  # 1-10 (1: ë§¤ìš° í”¼ê³¤, 10: ë§¤ìš° í™œê¸°ì°¸)
    confidence_level = Column(Integer, nullable=True)  # 1-10 (1: ìì‹  ì—†ìŒ, 10: ë§¤ìš° ìì‹  ìˆìŒ)
    
    # í•™ìŠµ í™˜ê²½
    study_duration_minutes = Column(Integer, nullable=True)  # ê³„íší•œ í•™ìŠµ ì‹œê°„
    actual_duration_minutes = Column(Integer, nullable=True)  # ì‹¤ì œ í•™ìŠµ ì‹œê°„
    is_first_session_today = Column(Boolean, default=True)
    interruptions_count = Column(Integer, default=0)  # ì¤‘ë‹¨ íšŸìˆ˜
    
    # í•™ìŠµ íŒ¨í„´
    time_of_day = Column(String(20), nullable=True)  # "morning", "afternoon", "evening", "night"
    is_consecutive_day = Column(Boolean, default=False)  # ì—°ì† í•™ìŠµ ì¤‘ì¸ê°€
    consecutive_days_count = Column(Integer, default=0)  # ì—°ì† í•™ìŠµ ì¼ìˆ˜
    
    # í•™ìŠµ ëª©í‘œ ë° ë™ê¸°
    daily_goal = Column(String(200), nullable=True)  # ì˜¤ëŠ˜ì˜ í•™ìŠµ ëª©í‘œ
    motivation_level = Column(Integer, nullable=True)  # 1-10 ë™ê¸°ë¶€ì—¬ ìˆ˜ì¤€
    why_learning_today = Column(Text, nullable=True)  # ì˜¤ëŠ˜ ì™œ í•™ìŠµí•˜ëŠ”ê°€
    
    # ì–´ë ¤ì›€ ë° ì§€ì›
    current_struggle = Column(Text, nullable=True)  # í˜„ì¬ ê²ªê³  ìˆëŠ” ì–´ë ¤ì›€
    needs_encouragement = Column(Boolean, default=False)  # ê²©ë ¤ê°€ í•„ìš”í•œê°€
    preferred_support_type = Column(String(50), nullable=True)  # "gentle", "motivational", "technical"
    
    # ë©”íƒ€ë°ì´í„°
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False, index=True)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    # ê´€ê³„ ì„¤ì •
    user = relationship("User")
    track = relationship("LearningTrack")
    module = relationship("LearningModule")
    
    # ì¸ë±ìŠ¤
    __table_args__ = (
        Index('idx_learning_context_user_created', 'user_id', 'created_at'),
        Index('idx_learning_context_session', 'session_id'),
        Index('idx_learning_context_mood', 'mood'),
    )


class MoodCheckIn(Base):
    """
    ê¸°ë¶„ ì²´í¬ì¸ ê¸°ë¡
    
    í•™ìŠµ ì „í›„ì˜ ê°ì • ìƒíƒœë¥¼ ì¶”ì í•˜ì—¬
    í•™ìŠµì´ ê°ì •ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ ë¶„ì„
    """
    __tablename__ = "mood_check_ins"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    context_id = Column(Integer, ForeignKey("learning_contexts.id"), nullable=True, index=True)
    
    # ì²´í¬ì¸ íƒ€ì´ë°
    check_in_type = Column(String(20), nullable=False)  # "before_learning", "after_learning", "during_break"
    
    # ê°ì • ìƒíƒœ
    mood = Column(String(20), nullable=False)  # "great", "good", "okay", "struggling", "frustrated", "exhausted"
    mood_emoji = Column(String(10), nullable=True)  # "ğŸ˜Š", "ğŸ˜", "ğŸ˜”", "ğŸ˜«"
    energy_level = Column(Integer, nullable=False)  # 1-10
    stress_level = Column(Integer, nullable=False)  # 1-10 (1: í¸ì•ˆí•¨, 10: ë§¤ìš° ìŠ¤íŠ¸ë ˆìŠ¤)
    
    # ê°ì •ì— ëŒ€í•œ ì„¤ëª… (ì„ íƒì )
    feeling_description = Column(Text, nullable=True)
    what_went_well = Column(Text, nullable=True)  # ì˜ëœ ì 
    what_was_hard = Column(Text, nullable=True)  # ì–´ë ¤ì› ë˜ ì 
    
    # ì‹ ì²´ ìƒíƒœ
    is_tired = Column(Boolean, default=False)
    is_hungry = Column(Boolean, default=False)
    is_distracted = Column(Boolean, default=False)
    
    # íƒ€ì„ìŠ¤íƒ¬í”„
    checked_in_at = Column(DateTime, default=datetime.utcnow, nullable=False, index=True)
    
    # ê´€ê³„ ì„¤ì •
    user = relationship("User")
    
    # ì¸ë±ìŠ¤
    __table_args__ = (
        Index('idx_mood_checkin_user_time', 'user_id', 'checked_in_at'),
        Index('idx_mood_checkin_type', 'check_in_type'),
        Index('idx_mood_checkin_mood', 'mood'),
    )


class EncouragingMessage(Base):
    """
    ê²©ë ¤ ë©”ì‹œì§€ ì‹œìŠ¤í…œ
    
    í•™ìŠµìì˜ ìƒíƒœì— ë”°ë¼ ê°œì¸í™”ëœ ê²©ë ¤ ë©”ì‹œì§€ ì œê³µ
    """
    __tablename__ = "encouraging_messages"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    
    # ë©”ì‹œì§€ íŠ¸ë¦¬ê±°
    trigger_type = Column(String(50), nullable=False, index=True)
    # "low_confidence", "consecutive_learning", "after_struggle", 
    # "first_success", "comeback", "milestone_reached"
    
    # ë©”ì‹œì§€ ë‚´ìš©
    message = Column(Text, nullable=False)
    message_tone = Column(String(20), nullable=False)  # "gentle", "motivational", "celebratory", "empathetic"
    
    # ë©”ì‹œì§€ íƒ€ì…
    is_ai_generated = Column(Boolean, default=False)  # AIê°€ ìƒì„±í•œ ë©”ì‹œì§€ì¸ê°€
    is_personalized = Column(Boolean, default=True)  # ê°œì¸í™”ëœ ë©”ì‹œì§€ì¸ê°€
    
    # ì‚¬ìš©ì ë°˜ì‘
    was_helpful = Column(Boolean, nullable=True)  # ë„ì›€ì´ ë˜ì—ˆëŠ”ê°€
    user_feedback = Column(Text, nullable=True)
    
    # ì»¨í…ìŠ¤íŠ¸
    context_data = Column(JSON, nullable=True)  # ë©”ì‹œì§€ ìƒì„± ì‹œ ì‚¬ìš©ëœ ì»¨í…ìŠ¤íŠ¸
    
    # íƒ€ì„ìŠ¤íƒ¬í”„
    sent_at = Column(DateTime, default=datetime.utcnow, nullable=False, index=True)
    read_at = Column(DateTime, nullable=True)
    
    # ê´€ê³„ ì„¤ì •
    user = relationship("User")
    
    # ì¸ë±ìŠ¤
    __table_args__ = (
        Index('idx_encouraging_message_user_sent', 'user_id', 'sent_at'),
        Index('idx_encouraging_message_trigger', 'trigger_type'),
        Index('idx_encouraging_message_helpful', 'was_helpful'),
    )