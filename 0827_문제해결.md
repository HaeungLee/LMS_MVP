# 2025-08-27 LMS MVP 문제 해결 보고서

## 개요
오늘(2025-08-27) 로컬 개발 중 발생한 주요 문제를 진단하고 수정했습니다. 주된 증상은 브라우저에서 API 호출 시 CORS 관련 헤더 누락으로 인한 접근 실패와, 일부 환경에서 발생한 연결(REFUSED) 문제였습니다. 아래에 발견 내용, 조치, 검증 결과, 후속 권장사항을 정리합니다.

## 체크리스트
- [x] 문제 원인 파악 (CORS 헤더 누락 / 브라우저 ERR_CONNECTION_REFUSED)
- [x] 서버 측 CORS 미들웨어 등록 순서 수정 (항상 CORS 헤더가 응답에 포함되도록)
- [x] 프론트엔드에서 API_BASE_URL 정규화 로직 추가 (잘못된 값 예: ":8000" 처리)
- [x] 변경사항으로 curl을 이용해 응답 헤더 및 엔드포인트 정상 동작 확인
- [x] 리포트에 변경 파일 및 검증 결과 기록

## 발견된 문제들
### 1) CORS 헤더 누락으로 인한 브라우저 접근 실패
- 증상: 브라우저 콘솔에 "No 'Access-Control-Allow-Origin' header" 메시지 또는 요청 실패
- 원인: `CORSMiddleware`가 애플리케이션의 뒤쪽(다른 커스텀 미들웨어 뒤)에 등록되어, 일부 커스텀 미들웨어가 요청을 조기 응답(예: rate limit의 429)하면 CORS 미들웨어가 실행되지 않아 응답에 CORS 헤더가 누락됨.

### 2) 프론트엔드에서 ERR_CONNECTION_REFUSED(간헐적)
- 증상: 브라우저에서 `:8000/api/...` 등으로 실패하거나 `ERR_CONNECTION_REFUSED`가 발생.
- 원인(가능성 높은 원인들):
  - Vite 환경변수(`VITE_API_BASE_URL`)가 런타임에 잘못되었거나 누락되어 브라우저가 잘못된 호스트/포트로 요청함.
  - 프론트 개발 서버 재시작 전 캐시 또는 환경변수 미로딩.
  - (덜 가능성이지만) 로컬 네트워크/프록시 문제.

## 수행한 조치
### A. 백엔드
- 파일: `backend/app/main.py`
  - 조치: `CORSMiddleware` 등록을 FastAPI 앱 생성 직후(다른 커스텀 미들웨어보다 먼저)로 이동시켜 모든 경로와 조기 응답에서 CORS 헤더가 항상 포함되도록 수정.
  - 이유: 미들웨어 순서상 CORS가 먼저 실행되어야 조기 리턴 응답에도 헤더가 보장됩니다.

### B. 프론트엔드
- 파일: `frontend/src/services/apiClient.js`
  - 조치: `VITE_API_BASE_URL` 정규화 함수 추가 및 잘못된 값(예: ":8000", "localhost:8000" 등)을 보정하도록 변경. 결과적으로 `API_BASE_URL`이 항상 절대 URL(`http://...`)이 되도록 했습니다.
  - 조치: 개발 시 콘솔 디버그 로그(`[apiClient] API_BASE_URL = ...`) 추가.
  - 이유: 환경변수가 잘못 설정됐을 때 브라우저가 유효하지 않은 URL로 요청하는 문제를 예방하기 위함.

### C. 리포트 업데이트
- 파일: `0826_문제해결.md`에 `backend/app/main.py` 변경 항목을 추가하여 기록을 남겼습니다.

## 수정된 파일 목록
- backend/app/main.py — CORS 미들웨어 등록 위치 조정
- frontend/src/services/apiClient.js — VITE_API_BASE_URL 정규화 및 디버그 로그 추가
- 0826_문제해결.md — 리포트에 변경 내용 추가
- (이전에 수정된 파일) 기타: 기존 변경 이력 참조

## 검증 및 테스트
- 서버 상태 확인 (curl로 직접 호출)
  - `curl.exe -i -H "Origin: http://localhost:5174" http://127.0.0.1:8000/health` → 응답에 `access-control-allow-origin` 및 `access-control-allow-credentials`가 포함됨.
  - `curl.exe -i -H "Origin: http://localhost:5174" http://127.0.0.1:8000/api/v1/auth/me` → `401 Unauthorized`와 함께 CORS 헤더 노출(인증 실패는 정상 동작).
  - `curl.exe -i -H "Origin: http://localhost:5174" "http://127.0.0.1:8000/api/v1/dashboard/stats?subject=python_basics"` → `200 OK` 및 데이터와 CORS 헤더 확인.
- 프론트엔드 검증
  - `frontend/src/services/apiClient.js`에 normalize 로직을 추가했으므로, 프론트 개발 서버를 재시작하면 브라우저 콘솔에 `[apiClient] API_BASE_URL = ...` 로그가 찍힙니다. 찍히는 URL이 `http://localhost:8000/api/v1`인지 확인하세요.

## 권장 후속 조치
1. 프론트 개발 서버 재시작 후 브라우저에서 네트워크 요청 확인
   - Vite dev 서버를 재시작하세요: `cd frontend` → `npm run dev` 그리고 브라우저 캐시 비활성화(DevTools > Network > Disable cache) 후 새로고침.
   - Network 탭에서 실패한 요청을 선택해 `Request URL`을 확인하세요. 요청 URL이 올바른지(예: `http://localhost:8000/api/v1/...`) 확인합니다.
2. 로컬 환경 파일 점검
   - 루트 `env.sample` 및 (있다면) `frontend/.env`에 `VITE_API_BASE_URL`이 `http://localhost:8000`로 설정되어 있는지 확인.
3. 더 엄격한 로깅(선택)
   - 개발용으로 프론트 요청 시 요청 URL과 response.status를 더 상세히 로깅하면 재발 시 원인 파악이 빨라집니다.
4. 배포 환경 점검
   - 프로덕션 빌드 시에는 Vite 환경변수 설정 방식(빌드 타임에 주입)을 기억하세요. 개발과 빌드 시점의 env 값 차이로 인한 문제를 문서화해 두면 좋습니다.

## 상태 요약
- CORS 관련 문제: 해결됨 (미들웨어 위치 조정 후 모든 검사에서 CORS 헤더 확인)
- ERR_CONNECTION_REFUSED: 대부분의 원인은 프론트의 잘못된 BASE URL 또는 환경변수 미로딩이었음. 프론트 정규화 로직 추가로 재발 가능성 낮춤. 프론트 재시작 후 브라우저에서 최종 확인 필요.

---

## 해결된 문제 및 방법

- CORS 헤더 누락
  - 문제: 일부 요청이 커스텀 미들웨어에서 조기 응답되어 CORS 미들웨어가 실행되지 않음.
  - 해결: `backend/app/main.py`에서 `CORSMiddleware`를 FastAPI 앱 생성 직후로 이동하여 항상 CORS 헤더가 응답에 포함되도록 함.

- 브라우저에서의 연결 거부(REFUSED) 원인으로 추정되는 프론트 BASE URL 문제
  - 문제: 프론트엔드에서 환경변수가 잘못되었거나 누락되어 브라우저가 잘못된 URL로 요청했을 가능성.
  - 해결: `frontend/src/services/apiClient.js`에 `VITE_API_BASE_URL` 정규화 함수를 추가하여 `:8000`, `localhost:8000` 등 잘못된 값을 보정하고 항상 절대 URL을 사용하도록 강제함.

- AI 생성 객관식 선택지 미표시
  - 문제: AI가 `options`라는 필드나 'A) 텍스트' 형식으로 반환하면 프론트의 `question.choices` 기대와 달라 선택지가 보이지 않음.
  - 해결: 백엔드 `app/services/ai_question_generator.py`에서 AI 응답 파싱 시 `options`를 `choices`로 복사하고, 각 선택지에서 접두사(A), 괄호, 점 등을 제거하여 깔끔한 선택지 텍스트를 생성하도록 정규화 로직을 추가함. 또한 프론트 `QuestionTypeGenerator.jsx`에서 `choices`뿐 아니라 `options`도 허용하도록 렌더러를 보완함.

## 변경된 파일 (요약)
- backend/app/main.py — CORS 미들웨어 위치 조정
- backend/app/services/ai_question_generator.py — AI 응답에서 선택지 정규화(옵션 필드 변환 및 접두사 제거)
- frontend/src/services/apiClient.js — VITE_API_BASE_URL 정규화 및 디버그 로그
- frontend/src/components/dashboard/QuestionTypeGenerator.jsx — choices/options 양방향 지원 및 렌더링 폴백


**작성일**: 2025-08-27
**작성자**: 자동화 지원 도구
**상태**: 조치 완료(검증 필요: 프론트 재시작 및 브라우저 네트워크 확인)
